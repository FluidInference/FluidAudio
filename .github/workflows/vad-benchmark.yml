name: VAD Benchmark

on:
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  vad-benchmark:
    runs-on: macos-latest
    timeout-minutes: 30
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
      - uses: swift-actions/setup-swift@v2
        with:
          swift-version: "6.1"

      - name: Cache Swift packages
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Caches/org.swift.swiftpm
          key: ${{ runner.os }}-swift-6.1-${{ hashFiles('Package.swift') }}

      - name: Cache VAD models
        uses: actions/cache@v4
        with:
          path: ~/Library/Application Support/FluidAudio/vad
          key: ${{ runner.os }}-vad-models-v5

      - name: Build
        run: swift build -c release

      - name: Run VAD Benchmark
        id: benchmark
        run: |
          BENCHMARK_START=$(date +%s)

          swift run fluidaudio vad-benchmark \
            --dataset mini100 \
            --num-files 100 \
            --threshold 0.445

          BENCHMARK_END=$(date +%s)
          EXECUTION_TIME=$((BENCHMARK_END - BENCHMARK_START))
          echo "EXECUTION_TIME=$((EXECUTION_TIME / 60))m $((EXECUTION_TIME % 60))s" >> $GITHUB_OUTPUT

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vad-benchmark-${{ github.sha }}
          path: vad_benchmark_results.json
          retention-days: 30

      - name: Comment PR with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let reportContent = '## VAD Benchmark Results\n\n';

            try {
              if (fs.existsSync('vad_benchmark_results.json')) {
                const results = JSON.parse(fs.readFileSync('vad_benchmark_results.json', 'utf8'));

                reportContent += `| Metric | Value | Target | Status |\n`;
                reportContent += `|--------|-------|--------|--------|\n`;
                reportContent += `| F1-Score | ${results.f1_score?.toFixed(1)}% | >70% | ${results.f1_score >= 70 ? '‚úÖ' : '‚ùå'} |\n`;
                reportContent += `| Accuracy | ${results.accuracy?.toFixed(1)}% | >70% | ${results.accuracy >= 70 ? '‚úÖ' : '‚ùå'} |\n`;
                reportContent += `| Precision | ${results.precision?.toFixed(1)}% | - | - |\n`;
                reportContent += `| Recall | ${results.recall?.toFixed(1)}% | - | - |\n\n`;

                reportContent += `<sub>${results.total_files} files ‚Ä¢ ${results.processing_time_seconds?.toFixed(1)}s ‚Ä¢ ${{ steps.benchmark.outputs.EXECUTION_TIME }}</sub>\n\n`;
                
                reportContent += `### Research Paper Comparisons\n\n`;
                reportContent += `| Paper | Dataset | F1-Score | Method |\n`;
                reportContent += `|-------|---------|----------|--------|\n`;
                reportContent += `| Silero VAD (2021) | TEDx | 88.1% | LSTM-based lightweight model |\n`;
                reportContent += `| WebRTC VAD | MUSAN | 64.4% | GMM-based (traditional) |\n`;
                reportContent += `| pyannote.audio (2020) | AMI | 85.9% | SincTDNN architecture |\n`;
                reportContent += `| MarbleNet (2020) | AVA-Speech | 87.8% | 1D time-channel separable CNN |\n`;
                reportContent += `| **FluidAudio VAD** | **MUSAN-mini** | **${results.f1_score?.toFixed(1)}%** | **CoreML-optimized Silero** |\n\n`;
                
                reportContent += `<details>\n`;
                reportContent += `<summary>üìä Industry Context</summary>\n\n`;
                reportContent += `- **Silero VAD**: Production-grade, optimized for edge devices\n`;
                reportContent += `- **WebRTC VAD**: Widely used but lower accuracy baseline\n`;
                reportContent += `- **pyannote.audio**: State-of-the-art for speaker diarization\n`;
                reportContent += `- **MarbleNet**: NVIDIA's efficient VAD for edge AI\n\n`;
                reportContent += `Note: Direct comparisons should consider dataset differences. MUSAN contains challenging noise conditions.\n`;
                reportContent += `</details>\n`;
              } else {
                reportContent += `‚ùå Benchmark failed - no results generated\n`;
              }

              reportContent += '<!-- fluidaudio-benchmark-vad -->';

              // Find and update existing comment
              const { data: comments } = await github.rest.issues.listComments({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
              });

              const existingComment = comments.find(c =>
                c.body.includes('<!-- fluidaudio-benchmark-vad -->')
              );

              if (existingComment) {
                await github.rest.issues.updateComment({
                  comment_id: existingComment.id,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: reportContent
                });
              } else {
                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: reportContent
                });
              }
            } catch (error) {
              console.error('Failed to post comment:', error);
            }

      - name: Validate performance
        run: |
          if [ -f "vad_benchmark_results.json" ]; then
            F1_SCORE=$(grep '"f1_score"' vad_benchmark_results.json | sed 's/.*: *\([0-9.]*\).*/\1/')
            if (( $(echo "$F1_SCORE < 70" | bc -l) )); then
              echo "‚ùå F1-Score $F1_SCORE% is below 70% threshold"
              exit 1
            fi
            echo "‚úÖ F1-Score $F1_SCORE% meets threshold"
          else
            echo "‚ùå No results file found"
            exit 1
          fi
