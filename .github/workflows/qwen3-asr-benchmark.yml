name: Qwen3-ASR Smoke Test

on:
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  qwen3-asr-smoke-test:
    name: Qwen3-ASR int8 Smoke Test
    runs-on: macos-15
    permissions:
      contents: read
      pull-requests: write

    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v5

      - uses: swift-actions/setup-swift@v2
        with:
          swift-version: "6.1"

      - name: Cache Dependencies
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Application Support/FluidAudio/Models/qwen3-asr-0.6b-coreml
            ~/Library/Application Support/FluidAudio/Datasets/LibriSpeech
            ~/Library/Caches/Homebrew
            /usr/local/Cellar/ffmpeg
            /opt/homebrew/Cellar/ffmpeg
          key: ${{ runner.os }}-qwen3-asr-${{ hashFiles('Package.resolved', 'Sources/FluidAudio/Frameworks/**', 'Sources/FluidAudio/ModelRegistry.swift', 'Sources/FluidAudio/ModelNames.swift') }}

      - name: Install ffmpeg
        run: |
          brew install ffmpeg || echo "ffmpeg may already be installed"

      - name: Build
        run: swift build -c release

      - name: Smoke Test (int8 download + load + transcribe)
        id: smoke
        run: |
          echo "========================================="
          echo "Qwen3-ASR int8 smoke test: download, load, transcribe 1 file"
          echo "========================================="

          # Run benchmark on 1 file just to verify the full pipeline works
          if .build/release/fluidaudiocli qwen3-benchmark \
            --variant int8 --max-files 1 \
            --output qwen3_smoke_result.json 2>&1; then
            echo "SMOKE_STATUS=PASS" >> $GITHUB_OUTPUT
            echo "Smoke test passed: int8 model downloaded, loaded, and transcribed successfully"
          else
            echo "SMOKE_STATUS=FAIL" >> $GITHUB_OUTPUT
            echo "Smoke test failed"
            exit 1
          fi

      - name: Comment PR
        if: github.event_name == 'pull_request'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.smoke.outputs.SMOKE_STATUS }}';
            const emoji = status === 'PASS' ? '✅' : '❌';

            const body = `## Qwen3-ASR int8 Smoke Test ${emoji}

            **Status:** int8 model download, load, and transcribe ${status === 'PASS' ? 'succeeded' : 'failed'}

            | | |
            |---|---|
            | Variant | int8 (571 MB decoder) |
            | Pipeline | download → load → transcribe 1 file |

            <sub>Full WER/RTFx benchmarks require physical Apple Silicon (CI VMs lack proper CoreML State API support)</sub>

            <!-- fluidaudio-benchmark-qwen3-asr -->`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existing = comments.find(c =>
              c.body.includes('<!-- fluidaudio-benchmark-qwen3-asr -->')
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Upload Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qwen3-asr-smoke-results
          path: qwen3_smoke_result.json
